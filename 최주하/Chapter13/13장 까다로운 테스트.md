# 13ì¥. ê¹Œë‹¤ë¡œìš´ í…ŒìŠ¤íŠ¸

## ë©€í‹° ìŠ¤ë ˆë“œ ì½”ë“œ í…ŒìŠ¤íŠ¸

ì´ë²ˆ ë¶€ë¶„ì—ì„œ ë‹¤ë£° ì½”ë“œëŠ” ProfileMatcher í´ë˜ìŠ¤ì´ë‹¤.

```java
public class ProfileMatcher {
   private Map<String, Profile> profiles = new HashMap<>(); 
   private static final int DEFAULT_POOL_SIZE = 4;

   public void add(Profile profile) {
      profiles.put(profile.getId(), profile);
   }

    
   public void findMatchingProfiles(
         Criteria criteria, MatchListener listener) {
      ExecutorService executor = 
            Executors.newFixedThreadPool(DEFAULT_POOL_SIZE);

      List<MatchSet> matchSets = profiles.values().stream()
            .map(profile -> profile.getMatchSet(criteria)) 
            .collect(Collectors.toList());
      for (MatchSet set: matchSets) {
         Runnable runnable = () -> {
            if (set.matches())
               listener.foundMatch(profiles.get(set.getProfileId()), set);
         };
         executor.execute(runnable);
      }
      executor.shutdown();
   }
}
```

### 1. ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œì§ê³¼ ìŠ¤ë ˆë“œ ë¡œì§ ë¶„ë¦¬í•˜ê¸°

â‘  ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œì§ì„ ì¶”ì¶œ

ë¨¼ì €, **profileê³¼ criteriaë¥¼ ë§¤ì¹­í•œ ê²°ê³¼ë¥¼ ë‹´ì•„ë‘ëŠ” matchSetì¸ìŠ¤í„´ìŠ¤ë¥¼ Listë¡œ ë§Œë“œëŠ” ë¡œì§**ì„ **`List<MatchSet>collectMatchSet(Criteria criteria)`**ìœ¼ë¡œ ë¶„ë¦¬í•œë‹¤.

```java
public void findMatchingProfiles(Criteria criteria, MatchListener listener) {
      ExecutorService executor = 
            Executors.newFixedThreadPool(DEFAULT_POOL_SIZE);
            
      for (MatchSet set: collectMatchSets(criteria)) {
         Runnable runnable = () -> {
            if (set.matches())
               listener.foundMatch(profiles.get(set.getProfileId()), set);
         };
         executor.execute(runnable);
      }
      executor.shutdown();
   }
}

// profileê³¼ citeriaë¥¼ ë§¤ì¹­í•œ ê²°ê³¼ë¥¼ Listë¡œ!
public List<MatchSet> collectMatchSets(Criteria criteria){
	return profiles.values().stream()
            .map(profile -> profile.getMatchSet(criteria)) 
            .collect(Collectors.toList());
}
```

í•´ë‹¹ ë¡œì§ì„ ë©”ì„œë“œë¡œ ì¶”ì¶œí•˜ê³ , ë©”ì„œë“œì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‘ì„±í•œë‹¤.

ë‹¤ìŒìœ¼ë¡œ, **ë§¤ì¹­ëœ profile ì •ë³´ë¥¼ ë¦¬ìŠ¤ë„ˆë¡œ ë„˜ê¸°ëŠ” ë¡œì§**ì„ ì¶”ì¶œí•œë‹¤.

```java
public void findMatchingProfiles(Criteria criteria, MatchListener listener) {
      ExecutorService executor = 
            Executors.newFixedThreadPool(DEFAULT_POOL_SIZE);
            
      for (MatchSet set: collectMatchSets(criteria)) {
         Runnable runnable = () -> process();
         executor.execute(runnable);
      }
      executor.shutdown();
   }
}

// ë§¤ì¹­ëœ ì •ë³´ë¥¼ listenerë¡œ!
void process(MatchListener listener, MatchSet set){
	if (set.matches()) listener.foundMatch(profiles.get(set.getProfileId()), set);
}
```

ëª¨í‚¤í† ë¥¼ í™œìš©í•´ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‘ì„±í•œë‹¤.


>ğŸ’¡ **How?**
>
>// Arrange<br>
>â‘  MatchListener ëª© ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•œë‹¤.<br>
>â‘¡ ë§¤ì¹­ë˜ëŠ” Profileì„ matcher ë³€ìˆ˜ì— ì¶”ê°€í•œë‹¤.<br>
>â‘¢ ì£¼ì–´ì§„ ì¡°ê±´ ì§‘í•©(ë§¤ê°œ ì¸ìë¡œ ë„˜ì–´ê°„ criteria)ì— ë§¤ì¹­ë˜ëŠ” Profileì— ëŒ€í•œ MatchSetì„ ì¤€ë¹„í•œë‹¤.
>
>// Act<br>
>â‘£ ëª© ì¸ìŠ¤í„´ìŠ¤ë¡œ ìƒì„±í•œ MatchListenerì™€ MatchSetì„ ë„˜ê²¨ process ë©”ì„œë“œë¥¼ ì‹¤í–‰ì‹œí‚¨ë‹¤.
>
>// Assert<br>
>â‘¤ ëª© ê°ì²´ì¸ MatchListenerì˜ foundMatch() ê°€ í˜¸ì¶œë˜ì—ˆëŠ”ì§€ í™•ì¸í•œë‹¤.



ì´ì œ ë‚¨ì€ findMatchingProfiles()ì˜ ëŒ€ë¶€ë¶„ì€ ìŠ¤ë ˆë“œ ë¡œì§ì´ë‹¤.

## 2. ìŠ¤ë ˆë“œ ë¡œì§ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ì½”ë“œ ìˆ˜ì •

ìŠ¤ë ˆë“œ ë¡œì§ì„ í…ŒìŠ¤íŠ¸ í•˜ê¸° ìœ„í•´ì„œ í…ŒìŠ¤íŠ¸ ì½”ë“œì—ì„œ ExecutorService ì¸ìŠ¤í„´ìŠ¤ì— ì ‘ê·¼í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤. ë”°ë¼ì„œ **ExecutorServiceë¥¼ ì´ˆê¸°í™” í•„ë“œë¡œ ì¶”ì¶œ**í•˜ê³ ,

```java
private ExecutorService executor = 
    Executors.newFixedThreadPool(DEFAULT_POOL_SIZE);
```

ë™ì¼ íŒ¨í‚¤ì§€ í—ˆìš©ì˜ ì ‘ê·¼ì œì–´ìì¸ default ìˆ˜ì¤€ìœ¼ë¡œ **getter ë©”ì„œë“œ**ë¥¼ ì‘ì„±í•œë‹¤.

```java
ExecutorService getExecutor() {
    return executor;
}
```

ì´í›„, process()ë¥¼ ìŠ¤í… ì²˜ë¦¬í•˜ê¸° ìœ„í•´ findMatchingProfiles() ë¥¼ ì˜¤ë²„ë¡œë”©í•œë‹¤.

```java
public void findMatchingProfiles( 
         Criteria criteria, 
         MatchListener listener, 
         List<MatchSet> matchSets,
         BiConsumer<MatchListener, MatchSet> processFunction) {
      for (MatchSet set: matchSets) {
         Runnable runnable = () -> processFunction.accept(listener, set); 
         executor.execute(runnable);
      }
      executor.shutdown();
   }
   
public void findMatchingProfiles(Criteria criteria, MatchListener listener) {
      findMatchingProfiles(criteria, listener, 
      collectMatcheSets(criteria), this::process);
}
```

ìŠ¤ë ˆë“œ ë¡œì§ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ ë¡œì§ì„ ì‘ì„±í•œë‹¤.



>ğŸ’¡ **How?**
>
>// Arrange<br>
>â‘  Listenerê°€ ë°›ì„ MatchSet ê°ì²´ë“¤ì˜ Profile Id ëª©ë¡ì„ ì €ì¥í•  Set<String> ê°ì²´ë¥¼ ìƒì„±í•œë‹¤.<br>
>â‘¡ process()ì„ ëŒ€ì‹ í•  processFunctionì„ ì •ì˜í•œë‹¤.<br>
>â‘¢ profileId ê°’ì„ processedSetsì— ë„£ëŠ”ë‹¤.<br>
>â‘£ ì„ì‹œ ë°ì´í„°ë¥¼ ë§Œë“œëŠ” createMatchSetsì„ ë§Œë“¤ê³ , í•´ë‹¹ ë©”ì„œë“œë¥¼ ì‚¬ìš©í•´ 100ê°œì˜ MatchSet ê°ì²´ë¥¼ ë§Œë“ ë‹¤.<br>
>â‘¤ í•¨ìˆ˜ë¥¼ ë§¤ê°œì¸ìë¡œ ê°–ëŠ” findMatchingProfiles ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ê³ , processFunction()ì„ ë„˜ê¸´ë‹¤.<br>
>
>// Act<br>
>â‘¥ matcherì— ìˆëŠ” Executor() ê°ì²´ë¥¼ í†µí•´ ëª¨ë“  ìŠ¤ë ˆë“œ ì‹¤í–‰ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ë°˜ë³µí•œë‹¤.
>
>// Assert<br>
>â‘¦ processedSetsì— ì €ì¥ëœ profileIdì™€ í…ŒìŠ¤íŠ¸ì—ì„œ ìƒì„±ëœ MatcheSet ê°ì²´ì˜ Idì™€ ë™ì¼í•œì§€ ë¹„êµí•œë‹¤.
>

# ë°ì´í„°ë² ì´ìŠ¤ í…ŒìŠ¤íŠ¸

â­ í…ŒìŠ¤íŠ¸ ë§ˆë‹¤ íŠ¸ëœì­ì…˜ì„ ì´ˆê¸°í™” í•˜ê³ , í…ŒìŠ¤íŠ¸ê°€ ëë‚˜ë©´ ë¡¤ë°±í•˜ê¸°(íŠ¸ëœì­ì…˜ ì²˜ë¦¬ëŠ” ë³´í†µ @Before, @Afterì— ìœ„ì„)

### í´ë¦° ë£¸ ë°ì´í„° ë² ì´ìŠ¤ í…ŒìŠ¤íŠ¸

@Beforeì™€ @Afterë©”ì„œë“œì—ì„œ deleteAll()ì„ í˜¸ì¶œí•´ì„œ ë°ì´í„°ë¥¼ ë¹„ì›Œì¤€ë‹¤. ë§Œì•½, í…ŒìŠ¤íŠ¸ê°€ ì™„ë£Œëœ í›„ì˜ ë°ì´í„°ë¥¼ ë³´ê³ ì í•œë‹¤ë©´, @After ë©”ì„œë“œì—ì„œ deleteAll()ì„ ì£¼ì„ì²˜ë¦¬í•´ì¤€ë‹¤.